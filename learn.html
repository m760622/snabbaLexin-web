<!DOCTYPE html>
<html lang="sv" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LÃ¤r dig Svenska Grammatik | ØªØ¹Ù„Ù… Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠØ© - SnabbaLexin</title>
    <meta name="description"
        content="LÃ¤r dig svensk grammatik: ordfÃ¶ljd, verb, pronomen, adjektiv med quiz och Ã¶vningar. Anpassat fÃ¶r arabisktalande.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;600&family=Inter:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="learn.css">
</head>

<body>
    <header>
        <button class="back-btn" onclick="window.location.href='index.html'" aria-label="Tillbaka" title="Tillbaka">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
        </button>
        <button id="mobileToggle" class="mobile-toggle-btn" onclick="toggleMobileView()">ğŸ“±</button>
        <h1>LÃ¤r dig Svenska / ØªØ¹Ù„Ù… Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠØ©</h1>
    </header>

    <!-- Progress Hero -->
    <div class="progress-hero">
        <div class="hero-stats">
            <div class="hero-stat">
                <div class="value" id="streakCount">0</div>
                <div class="label">ğŸ”¥ Dagar</div>
            </div>
            <div class="hero-stat">
                <div class="value" id="totalXP">0</div>
                <div class="label">â­ XP</div>
            </div>
            <div class="hero-stat">
                <div class="value" id="completedCount">0</div>
                <div class="label">âœ… Klara</div>
            </div>
        </div>
        <div class="overall-progress">
            <div class="fill" id="overallProgress"></div>
        </div>
        <div class="progress-text" id="progressText">0% klar / Ù…ÙƒØªÙ…Ù„</div>
    </div>

    <!-- Review Banner -->
    <div class="review-banner hidden" id="reviewBanner" onclick="openReviewSession()">
        <div class="review-icon">ğŸ”„</div>
        <div class="review-content">
            <div class="review-title">Dags fÃ¶r repetition! / ÙˆÙ‚Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
            <div class="review-subtitle"><span id="reviewCount">0</span> ord att repetera</div>
        </div>
    </div>

    <main>
        <div class="search-container">
            <input type="text" id="lessonSearchInput" placeholder="SÃ¶k lektioner / Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø³...">
        </div>

        <div class="filter-scroll-container">
            <button class="filter-chip active" data-filter="all">Alla / Ø§Ù„ÙƒÙ„</button>
            <button class="filter-chip" data-filter="beginner">ğŸŸ¢ NybÃ¶rjare</button>
            <button class="filter-chip" data-filter="intermediate">ğŸŸ¡ Medel</button>
            <button class="filter-chip" data-filter="advanced">ğŸ”´ Avancerad</button>
        </div>

        <!-- Special Cards -->
        <div class="special-section">
            <div class="section-title">ğŸŒŸ SnabbspÃ¥r / Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</div>
            <div class="special-cards">
                <div class="special-card" onclick="window.location.href='cognates.html'">
                    <div class="icon">ğŸ”¤</div>
                    <div class="title">Liknande Ord</div>
                    <div class="subtitle">Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª</div>
                </div>
                <!-- New Quran Card -->
                <div class="special-card" onclick="window.location.href='quran.html'">
                    <div class="icon">ğŸ“–</div>
                    <div class="title">Koranord</div>
                    <div class="subtitle">ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†</div>
                </div>
                <div class="special-card" onclick="openRandomQuiz()">
                    <div class="icon">ğŸ²</div>
                    <div class="title">SlumpmÃ¤ssig Quiz</div>
                    <div class="subtitle">Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ</div>
                </div>
            </div>
        </div>

        <!-- Lessons Section -->
        <div class="section-title">ğŸ“š Lektioner / Ø§Ù„Ø¯Ø±ÙˆØ³</div>
        <div class="lessons-grid" id="lessonsGrid">
            <!-- Dynamic -->
        </div>
    </main>

    <!-- Lesson Modal -->
    <div id="lessonModal" class="lesson-modal">
        <div class="modal-header">
            <button class="close-lesson" onclick="closeLessonModal()">Ã—</button>
            <h2 id="modalTitle">Lektion</h2>
        </div>
        <div id="lessonContent" class="lesson-content"></div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/lessonsData.js"></script>
    <script>
        // ========== STATE ==========
        let completedLessons = JSON.parse(localStorage.getItem('completedLessons') || '[]');
        let lessonProgress = JSON.parse(localStorage.getItem('lessonProgress') || '{}');
        let learningStats = JSON.parse(localStorage.getItem('learningStats') || '{"streak": 0, "lastDate": "", "totalXP": 0}');
        let reviewWords = JSON.parse(localStorage.getItem('reviewWords') || '[]');

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', () => {
            // Theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            if (localStorage.getItem('mobileView') === 'true') {
                document.documentElement.classList.add('iphone-mode');
                document.body.classList.add('iphone-view');
                document.getElementById('mobileToggle').classList.add('active');
            }

            updateDailyStats();
            updateProgressUI();
            renderLessons();
            checkReviewWords();

            // Search
            document.getElementById('lessonSearchInput').addEventListener('input', filterLessons);

            // Filter chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    filterLessons();
                });
            });
        });

        function toggleMobileView() {
            document.documentElement.classList.toggle('iphone-mode');
            document.body.classList.toggle('iphone-view');
            const isActive = document.body.classList.contains('iphone-view');
            localStorage.setItem('mobileView', isActive ? 'true' : 'false');
            document.getElementById('mobileToggle').classList.toggle('active', isActive);
        }

        // ========== STATS ==========
        function updateDailyStats() {
            const today = new Date().toISOString().split('T')[0];

            if (learningStats.lastDate !== today) {
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                if (learningStats.lastDate === yesterday) {
                    learningStats.streak++;
                } else if (learningStats.lastDate && learningStats.lastDate !== today) {
                    learningStats.streak = 1;
                } else if (!learningStats.lastDate) {
                    learningStats.streak = 1;
                }
                learningStats.lastDate = today;
                learningStats.totalXP += 10; // Login bonus
                localStorage.setItem('learningStats', JSON.stringify(learningStats));
            }
        }

        function updateProgressUI() {
            document.getElementById('streakCount').textContent = learningStats.streak;
            document.getElementById('totalXP').textContent = learningStats.totalXP;
            document.getElementById('completedCount').textContent = completedLessons.length;

            const totalLessons = lessonsData.length;
            const progress = totalLessons > 0 ? Math.round((completedLessons.length / totalLessons) * 100) : 0;
            document.getElementById('overallProgress').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${progress}% klar / Ù…ÙƒØªÙ…Ù„`;
        }

        function addXP(amount) {
            learningStats.totalXP += amount;
            localStorage.setItem('learningStats', JSON.stringify(learningStats));
            updateProgressUI();
        }

        // ========== LESSONS ==========
        function renderLessons() {
            const grid = document.getElementById('lessonsGrid');
            grid.innerHTML = lessonsData.map((lesson, index) => {
                const isCompleted = completedLessons.includes(lesson.id);
                const progress = lessonProgress[lesson.id] || 0;
                const levelClass = lesson.level || 'beginner';

                return `
                    <div class="lesson-card ${isCompleted ? 'completed' : ''}" onclick="openLesson('${lesson.id}')">
                        ${isCompleted ? '<div class="lesson-badge">âœ“</div>' : ''}
                        <div class="lesson-icon">${getIconForLesson(lesson.id)}</div>
                        <div class="lesson-info">
                            <div class="lesson-title">${lesson.title}</div>
                            <div class="lesson-subtitle">${getSubtitleForLesson(lesson.id)}</div>
                            <div class="lesson-desc">${getDescForLesson(lesson.id)}</div>
                        </div>
                        <span class="level-badge ${levelClass}">${getLevelLabel(levelClass)}</span>
                        <div class="lesson-progress"><div class="fill" style="width: ${progress}%"></div></div>
                    </div>`;
            }).join('');
        }

        function filterLessons() {
            const searchTerm = document.getElementById('lessonSearchInput').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-chip.active').dataset.filter;

            document.querySelectorAll('.lesson-card').forEach((card, index) => {
                const lesson = lessonsData[index];
                const matchesSearch = lesson.title.toLowerCase().includes(searchTerm) ||
                    getSubtitleForLesson(lesson.id).toLowerCase().includes(searchTerm);
                const matchesFilter = activeFilter === 'all' || lesson.level === activeFilter;
                card.style.display = matchesSearch && matchesFilter ? 'flex' : 'none';
            });
        }

        function getIconForLesson(id) {
            const icons = {
                wordOrder: 'ğŸ“', pronouns: 'ğŸ‘¤', verbs: 'ğŸƒ', adjectives: 'ğŸ¨',
                prepositions: 'ğŸ“', gender: 'âš–ï¸', questions: 'â“', numbers: 'ğŸ”¢',
                phrases: 'ğŸ’¬', falseFriends: 'ğŸ­', hospital: 'ğŸ¥', work: 'ğŸ’¼',
                bank: 'ğŸ¦', mistakes: 'âš ï¸', airport: 'âœˆï¸', onlineShopping: 'ğŸ›’'
            };
            return icons[id] || 'ğŸ“š';
        }

        function getSubtitleForLesson(id) {
            const subs = {
                wordOrder: 'ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ù…Ù„Ø© - Ù‚Ø§Ø¹Ø¯Ø© V2', pronouns: 'Ø§Ù„Ø¶Ù…Ø§Ø¦Ø± Ø§Ù„Ø´Ø®ØµÙŠØ©', verbs: 'Ø§Ù„Ø£ÙØ¹Ø§Ù„ ÙˆØ§Ù„Ø£Ø²Ù…Ù†Ø©',
                adjectives: 'Ø§Ù„ØµÙØ§Øª', prepositions: 'Ø­Ø±ÙˆÙ Ø§Ù„Ø¬Ø±', gender: 'Ø§Ù„Ù…Ø°ÙƒØ± ÙˆØ§Ù„Ù…Ø¤Ù†Ø«',
                questions: 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ù†ÙÙŠ', numbers: 'Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„ÙˆÙ‚Øª', phrases: 'Ø¹Ø¨Ø§Ø±Ø§Øª Ø´Ø§Ø¦Ø¹Ø©',
                falseFriends: 'Ø£ØµØ¯Ù‚Ø§Ø¡ Ù…Ø®Ø§Ø¯Ø¹ÙˆÙ†', hospital: 'ÙÙŠ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰', work: 'ÙÙŠ Ø§Ù„Ø¹Ù…Ù„',
                bank: 'ÙÙŠ Ø§Ù„Ø¨Ù†Ùƒ', mistakes: 'Ø£Ø®Ø·Ø§Ø¡ Ø´Ø§Ø¦Ø¹Ø©', airport: 'ÙÙŠ Ø§Ù„Ù…Ø·Ø§Ø±', onlineShopping: 'Ø§Ù„ØªØ³ÙˆÙ‚ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª'
            };
            return subs[id] || '';
        }

        function getDescForLesson(id) {
            const descs = {
                wordOrder: 'LÃ¤r dig hur svenska meningar Ã¤r uppbyggda och den viktiga V2-regeln.',
                pronouns: 'Personliga pronomen: jag, du, han, hon, vi, ni, de',
                verbs: 'Presens, preteritum, perfekt och futurum',
                adjectives: 'Hur adjektiv bÃ¶js: en stor bil, ett stort hus',
                prepositions: 'i, pÃ¥, till, frÃ¥n, med, utan, fÃ¶r, av...',
                gender: 'Genus i svenska: en bok, ett bord',
                questions: 'Hur man stÃ¤ller frÃ¥gor och sÃ¤ger nej pÃ¥ svenska',
                numbers: '1-100, klockan, dagar och mÃ¥nader',
                phrases: 'HÃ¤lsningar, artighetsfraser och vardagsuttryck',
                falseFriends: 'Ord som liknar arabiska men har annan betydelse',
                hospital: 'Fraser och ord du behÃ¶ver pÃ¥ vÃ¥rdcentralen',
                work: 'Vanliga uttryck pÃ¥ arbetsplatsen',
                bank: 'Ord och fraser fÃ¶r bankÃ¤renden',
                mistakes: 'Typiska fel som arabisktalande gÃ¶r',
                airport: 'Incheckning, sÃ¤kerhetskontroll, ombord',
                onlineShopping: 'BestÃ¤lla, betala, leverans och retur'
            };
            return descs[id] || '';
        }

        function getLevelLabel(level) {
            const labels = { beginner: 'Ù†Ø¨ØªØ¯Ø¦', intermediate: 'Ù…ØªÙˆØ³Ø·', advanced: 'Ù…ØªÙ‚Ø¯Ù…' };
            return labels[level] || '';
        }

        // ========== LESSON MODAL ==========
        function openLesson(id) {
            const lesson = lessonsData.find(l => l.id === id);
            if (!lesson) return;

            document.getElementById('modalTitle').textContent = lesson.title;
            let html = '';

            lesson.sections.forEach(section => {
                html += `<div class="lesson-section"><h3>${section.title}</h3>`;
                section.content.forEach(item => {
                    if (item.type === 'p') html += `<p>${item.html}</p>`;
                    else if (item.type === 'rule') html += `<div class="rule-highlight">${item.html}</div>`;
                });

                if (section.examples && section.examples.length > 0) {
                    section.examples.forEach(ex => {
                        html += `
                            <div class="example-box">
                                <div class="swe">
                                    ${ex.swe}
                                    <button class="speak-btn" onclick="speakText('${ex.swe.replace(/'/g, "\\'")}', 'sv')">ğŸ”Š</button>
                                </div>
                                <div class="arb">${ex.arb}</div>
                            </div>`;
                    });
                }
                html += '</div>';
            });

            // Quiz button
            html += `
                <div class="lesson-completion">
                    <button class="quiz-start-btn" onclick="startLessonQuiz('${id}')">
                        ğŸ“ Testa dig / Ø§Ø®ØªØ¨Ø± Ù†ÙØ³Ùƒ
                    </button>
                </div>`;

            document.getElementById('lessonContent').innerHTML = html;
            document.getElementById('lessonModal').classList.add('active');

            // Track progress
            if (!lessonProgress[id]) lessonProgress[id] = 50;
            localStorage.setItem('lessonProgress', JSON.stringify(lessonProgress));
        }

        function closeLessonModal() {
            document.getElementById('lessonModal').classList.remove('active');
            renderLessons();
        }

        function speakText(text, lang) {
            if (typeof TTSManager !== 'undefined') {
                TTSManager.speak(text, lang);
            } else {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang === 'sv' ? 'sv-SE' : 'ar-SA';
                window.speechSynthesis.speak(u);
            }
        }

        // ========== QUIZ ==========
        let currentQuiz = null;

        function startLessonQuiz(lessonId) {
            const lesson = lessonsData.find(l => l.id === lessonId);
            if (!lesson) return;

            // Collect examples for quiz
            const allExamples = [];
            lesson.sections.forEach(section => {
                if (section.examples) {
                    section.examples.forEach(ex => {
                        allExamples.push({ swe: ex.swe, arb: ex.arb });
                    });
                }
            });

            if (allExamples.length < 4) {
                alert('Inte tillrÃ¤ckligt med exempel fÃ¶r quiz!');
                return;
            }

            const shuffled = [...allExamples].sort(() => 0.5 - Math.random());
            currentQuiz = {
                lessonId: lessonId,
                questions: shuffled.slice(0, Math.min(10, shuffled.length)),
                pool: allExamples,
                index: 0,
                score: 0
            };

            renderQuizQuestion();
        }

        function renderQuizQuestion() {
            const q = currentQuiz.questions[currentQuiz.index];
            const total = currentQuiz.questions.length;

            const wrongPool = currentQuiz.pool.filter(ex => ex.swe !== q.swe);
            const wrongOptions = wrongPool.sort(() => 0.5 - Math.random()).slice(0, 3).map(ex => ex.arb);
            const options = [q.arb, ...wrongOptions].sort(() => 0.5 - Math.random());

            const html = `
                <div class="quiz-container">
                    <div class="quiz-header">
                        <h2>FrÃ¥ga ${currentQuiz.index + 1} / ${total}</h2>
                        <div class="progress-bar"><div style="width: ${(currentQuiz.index / total) * 100}%"></div></div>
                    </div>
                    <div class="question-card">
                        <div class="question-text">${q.swe}</div>
                        <div class="options-grid" id="quizOptions">
                            ${options.map(opt => `
                                <button class="option-btn" data-correct="${opt === q.arb}" onclick="checkQuizAnswer(this, ${opt === q.arb})">
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>
                        <div id="quizFeedback"></div>
                    </div>
                </div>`;

            document.getElementById('lessonContent').innerHTML = html;
        }

        function checkQuizAnswer(btn, isCorrect) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(b => {
                b.disabled = true;
                if (b.getAttribute('data-correct') === 'true') b.classList.add('correct-answer');
                else if (b === btn && !isCorrect) b.classList.add('wrong-answer');
            });

            const feedback = document.getElementById('quizFeedback');
            if (isCorrect) {
                currentQuiz.score++;
                feedback.innerHTML = '<div class="answer-feedback feedback-correct-box">âœ… RÃ¤tt! / ØµØ­ÙŠØ­!</div>';
            } else {
                feedback.innerHTML = '<div class="answer-feedback feedback-wrong-box">âŒ Fel! / Ø®Ø·Ø£!</div>';
            }

            setTimeout(() => {
                currentQuiz.index++;
                if (currentQuiz.index < currentQuiz.questions.length) {
                    renderQuizQuestion();
                } else {
                    showQuizResults();
                }
            }, 1500);
        }

        function showQuizResults() {
            const score = currentQuiz.score;
            const total = currentQuiz.questions.length;
            const percent = Math.round((score / total) * 100);
            const passed = percent >= 70;

            if (passed) {
                if (!completedLessons.includes(currentQuiz.lessonId)) {
                    completedLessons.push(currentQuiz.lessonId);
                    localStorage.setItem('completedLessons', JSON.stringify(completedLessons));
                }
                lessonProgress[currentQuiz.lessonId] = 100;
                localStorage.setItem('lessonProgress', JSON.stringify(lessonProgress));
                addXP(50);
            } else {
                addXP(10);
            }

            const html = `
                <div class="quiz-results">
                    <div class="result-icon">${passed ? 'ğŸ‰' : 'ğŸ“š'}</div>
                    <h2>${passed ? 'Grattis! / Ù…Ø¨Ø±ÙˆÙƒ!' : 'FortsÃ¤tt Ã¶va!'}</h2>
                    <p>${score} / ${total} rÃ¤tt (${percent}%)</p>
                    <p style="color: var(--primary);">+${passed ? 50 : 10} XP</p>
                    <div class="result-actions">
                        <button class="result-btn success" onclick="closeLessonModal()">FortsÃ¤tt</button>
                        <button class="result-btn retry" onclick="startLessonQuiz('${currentQuiz.lessonId}')">FÃ¶rsÃ¶k igen</button>
                    </div>
                </div>`;

            document.getElementById('lessonContent').innerHTML = html;
        }

        // ========== REVIEW ==========
        function checkReviewWords() {
            // Simple spaced repetition check
            const today = new Date().toISOString().split('T')[0];
            const dueWords = reviewWords.filter(w => w.nextReview <= today);

            if (dueWords.length > 0) {
                document.getElementById('reviewBanner').classList.remove('hidden');
                document.getElementById('reviewCount').textContent = dueWords.length;
            }
        }

        function openReviewSession() {
            alert('Repetition kommer snart! / Ù‚Ø±ÙŠØ¨Ø§Ù‹!');
        }

        function openRandomQuiz() {
            const randomLesson = lessonsData[Math.floor(Math.random() * lessonsData.length)];
            openLesson(randomLesson.id);
        }
    </script>
    <script src="utils.js"></script>
    <script src="pwa.js" defer></script>
</body>

</html>